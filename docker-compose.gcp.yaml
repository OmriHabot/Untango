version: '3.8'

services:
  rag-backend:
    build: .
    container_name: rag-backend-gcp
    ports:
      - "8001:8001"
    volumes:
      - ./app:/app/app
      - ./service-account-key.json:/app/gcp-key.json:ro
      - repos_data:/app/repos
    environment:
      - CHROMA_HOST=${CHROMA_HOST:-chroma-service-url}
      - CHROMA_PORT=${CHROMA_PORT:-443}
      - CHROMA_SSL=${CHROMA_SSL:-TRUE}
      - CHROMA_COLLECTION_NAME=python_code_chunks
      - CHROMA_AUTH_PROVIDER=google_iam
      - GOOGLE_APPLICATION_CREDENTIALS=/app/gcp-key.json
      - GOOGLE_CLOUD_PROJECT=coms-6998-478617
      - GOOGLE_CLOUD_LOCATION=global
    restart: unless-stopped
    command: >
      sh -c "sleep 5 && uvicorn app.main:app --host 0.0.0.0 --port 8001 --reload --reload-dir /app/app --reload-exclude '*/repos/*' --timeout-keep-alive 75 --timeout-graceful-shutdown 10"

volumes:
  repos_data:
